<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Guide Debian 7 (partie 4/8) : gÃ©rer le trafic entrant et sortant avec Iptables</title>
    <meta name="description" content="Cet article fait partie dâ€™une sÃ©rie de billets portant sur la mise en place dâ€™un serveur sous Debian Wheezy (sommaireÂ du guide Debian Wheezy).">

    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="canonical" href="http://elliptips.info/guide-debian-7-gerer-le-trafic-entrant-et-sortant-avec-iptables/">
    <link rel="alternate" type="application/rss+xml" title="Elliptips" href="/feed.xml">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600" rel="stylesheet">
    <link href="https://file.myfontastic.com/A2MgA9Cd47cENMsNJcc2Gk/icons.css" rel="stylesheet">
    
    
</head>


  <body>

    <header class="header" role="banner">
    <div class="container">
        <a class="logo" href="/">Elliptips</a>

        <nav class="nav">
            <a href="">A propos</a>
            <a href="https://twitter.com/robin_parisi" target="_blank">Twitter</a>
            <a href="https://github.com/robinparisi" target="_blank">Github</a>
        </nav>
    </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <div class="post-header__wrapper container">
            <h1 class="post-title" itemprop="name headline">Guide Debian 7 (partie 4/8) : gÃ©rer le trafic entrant et sortant avec Iptables</h1>
            <div class="post-context">
                <div><i class="post-metaIcon icon-calendar"></i><span class="post-metaItem"><time datetime="2013-07-04T20:49:48+02:00" itemprop="datePublished">publiÃ© le 04/07/2013</time></span></div>
                <div><i class="post-metaIcon icon-clock"></i><span class="post-metaItem">Temps de lecture : 

3 mins

</span></div>
                <div><i class="post-metaIcon icon-pencil"></i><span class="post-metaItem"><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Robin</span></span></span></div>
                <div class="post-shareBox">
                    Partager :
                    <a href="#" title="Partager sur Twitter"><i class="icon-twitter color-twitter"></i></a>
                    <a href="#" title="Partager sur Facebook"><i class="icon-facebook color-facebook"></i></a>
                    <a href="#" title="Partager sur Google+"><i class="icon-google-plus color-google"></i></a>
                    <a href="#" title="Partager par e-mail+"><i class="icon-envelope color-mail"></i></a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="post-content" itemprop="articleBody">
            <p>Cet article fait partie dâ€™une sÃ©rie de billets portant sur la mise en place dâ€™un serveur sous Debian Wheezy (<a href="http://elliptips.info/guide-sur-linstallation-dun-serveur-sous-debian-7-wheezy/" title="Guide Debian Wheezy">sommaireÂ du guide Debian Wheezy</a>).</p>

<h2 id="introduction">Introduction</h2>

<p>Nous avons vu dans un article prÃ©cÃ©dent comment sÃ©curiser la porte dâ€™entrÃ©e de notre serveur, câ€™est-Ã -dire lâ€™accÃ¨s SSH. Câ€™est un dÃ©but, mais nâ€™oubliez pas que les fenÃªtres, elles, sont toujours ouvertesâ€¦</p>

<p>Dans lâ€™Ã©tat actuel, tout le trafic devrait Ãªtre autorisÃ© en <strong>entrÃ©e et sortie sur votre serveur</strong> (jâ€™utilise le conditionnel, car parfois, les prestataires mettent Ã  disposition un pare-feu intermÃ©diaire).</p>

<p>Pour rÃ©guler ces entrÃ©es/sorties, nous allons utiliser <a href="http://fr.wikipedia.org/wiki/Iptables" title="Iptables">Iptables</a>, <strong>un logiciel qui permet de configurer les rÃ¨gles du pare-feu</strong>, le tout en ligne de commandes. Il faut savoir que les rÃ¨gles Iptables sont rÃ©initialisÃ©es Ã  chaque reboot du serveur. La meilleure solution consiste donc Ã  les placer dans un petit script qui sâ€™occupera de mettre en place vos rÃ¨gles au dÃ©marrage de la machine.</p>

<h2 id="le-script">Le script</h2>

<p>Bonne nouvelle, nul besoin de rÃ©inventer la roue, car il existe sur le net une multitude de scripts pour gÃ©rer le firewall. Nous allons utiliser le script de Nicolargo (qui au passage tient un excellent blog:Â <a href="http://blog.nicolargo.com/">http://blog.nicolargo.com/</a> ).</p>

<p>Jâ€™ai forkÃ© le script pour mes propres besoins et pour Ãªtre sÃ»r que celui-ci reste accessible. On commence donc par le rÃ©cupÃ©rer depuis Github :</p>

<pre class="lang:sh decode:true">wget --no-check-certificate https://raw.github.com/robinparisi/debian-scripts/master/firewall.sh
mv firewall.sh /etc/init.d/firewall.sh</pre>

<p>On rend le script exÃ©cutableÂ :</p>

<pre>chmod +x /etc/init.d/firewall.sh</pre>

<h2 id="configuration">Configuration</h2>

<pre>vim /etc/init.d/firewall.sh</pre>

<p>La configuration du script est rapideÂ :</p>

<pre># Services that the system will offer to the network
TCP_SERVICES="22" # SSH 
UDP_SERVICES=""
# Services the system will use from the network
REMOTE_TCP_SERVICES="80 443 25" # web browsing
REMOTE_UDP_SERVICES="53" # DNS
# FTP backups 
# Allow backups to an external FTP
FTP_BACKUPS=""</pre>

<p><span style="color: #ff0000;">Attention : le port SSH est ici le 22, mais nâ€™oubliez pas que nous lâ€™avons changÃ©. Adaptez donc la conf au port choisiÂ !</span></p>

<p>Pour lâ€™envoi de mail, il faut ajouter le port 25 dans REMOTE_TCP_SERVICES.</p>

<p>Il est possible de tester la configuration en appliquant lesÂ rÃ¨glesÂ pendant 30 secondes pour sâ€™assurer que tout va bienÂ :</p>

<pre class="lang:sh decode:true">/etc/init.d/firewall.sh test</pre>

<p>Essayez de vous reconnecter au serveur avec SSH durant ce laps de temps. Si tout se passe bien, vous pouvez alors activer les rÃ¨gles en lanÃ§ant la commande suivanteÂ :</p>

<pre>/etc/init.d/firewall.sh start</pre>

<p>Si un jour vous avez besoin dâ€™effacer les rÃ¨gles (tout autoriser en entrÃ©e et sortie), lancez la commande suivanteÂ :</p>

<pre>/etc/init.d/firewall.sh clear</pre>

<p><span style="color: #ff0000;">Warning !!! : ne lancez jamais la commande stop sur une connexion distante, car elle aurait pour effet de couper totalement lâ€™accÃ¨s au serveur (refuserÂ tout le trafic entrant).Â </span></p>

<h2 id="ajouter-le-script-au-dmarrage">Ajouter le script au dÃ©marrage</h2>

<pre class="lang:default decode:true">update-rc.d firewall.sh defaults</pre>

<p>pour lâ€™enlever Â :</p>

<pre class="lang:sh decode:true">update-rc.d -f firewall.sh remove</pre>

<h2 id="pour-aller-plus-loin">Pour aller plus loin</h2>

<p>Il faut lâ€™avouer, ce genre de script est bien pratique, mais il ne vous dispense pas de comprendre les rÃ¨gles Iptables qui sâ€™appliquent sur votre serveur.</p>

<p>Pour rappel, vous pouvez obtenir Ã  tout moment la liste desÂ rÃ¨glesÂ grÃ¢ce Ã  la commande suivanteÂ :</p>

<pre class="lang:sh decode:true">iptables -L</pre>

<p>Renseignez-vous sur le sujet, et surtout, Ã©vitez Ã  tout prix de faire des copier/coller de rÃ¨gles en provenance dâ€™internet que vous ne comprenez pas, car câ€™est en gÃ©nÃ©ral le meilleur moyen pour se retrouver sur le pas de la porte Ã Â tambourinerÂ comme un couillon aprÃ¨s sâ€™Ãªtre enfermÃ© dehors (jâ€™en connais qui se remÃ©morent des soirÃ©es sympathiquesÂ :P).</p>

<h2 id="j8217ai-bloqu-ma-connexion-ssh8230">Jâ€™ai bloquÃ© ma connexion SSHâ€¦</h2>

<p>Et voilÃ , on fait lâ€™idiot dans le fond depuis le dÃ©but des explicationsâ€¦ mais maintenant, qui a lâ€™air malin ?! ğŸ˜›</p>

<p>Ne vousÂ inquiÃ©tezÂ pas, tout nâ€™est pas perdu ğŸ™‚</p>

<p>Deux cas peuvent se prÃ©senter :</p>

<ul>
  <li>Vous avez jouÃ© avec des rÃ¨gles Iptables mais sans Ã©diter le script.Â Dans ce cas un reboot du serveur depuis son interface suffira Ã  rÃ©tablir les bonnes rÃ¨gles.</li>
  <li>Vous avez Ã©ditÃ© ou mal configurÃ© le script puis appliquÃ© directement les rÃ¨gles. Ici, il faudra passer par la console de rÃ©cupÃ©ration de votre prestataire. En montant la partition de votre serveur, vous serez capable dâ€™Ã©diter le script puis de rebooter le serveur.</li>
</ul>

        </div>
    </div>

    
</article>

      </div>
    </main>

    <div class="container">
    <footer class="footer txtcenter">
        Sauf mention spÃ©ciale, le contenu de ce site est distribuÃ© sous licence <a href="#">CC BY-NC-SA 3.0</a>
    </footer>
</div>


  </body>

</html>
